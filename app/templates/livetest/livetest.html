<!-- templates/livetest.html -->

{% extends 'base.html' %}
{% block title %}
Live Data Page - My Website
{% endblock %}

{% block content %}

<h1>Live Strategy</h1>

<style>

</style>

<div class="accordion" id="accordionExample">

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
        aria-expanded="false" aria-controls="collapseOne">
        Strategy Control
      </button>
    </h2>
    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
      data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <form action="{{ url_for('livetest.start_binance_websocket') }}" method="post">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="symbol" class="form-label">Symbol:</label>
                <input type="text" class="form-control" id="symbol" name="symbol" value="{{strategy_details.symbol}}"
                  required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="bollinger_window" class="form-label">Bollinger Window:</label>
                <input type="number" step="0.01" class="form-control" id="bollinger_window" name="bollinger_window"
                  value="{{strategy_details.bollinger_window}}" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="bollinger_dev" class="form-label">Bollinger Deviation:</label>
                <input type="number" step="0.01" class="form-control" id="bollinger_dev" name="bollinger_dev"
                  value="{{strategy_details.bollinger_dev}}" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="rsi_window" class="form-label">RSI Window:</label>
                <input type="number" step="0.01" class="form-control" id="rsi_window" name="rsi_window"
                  value="{{strategy_details.rsi_window}}" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="rsi_overbought" class="form-label">RSI Overbought Threshold:</label>
                <input type="number" step="0.01" class="form-control" id="rsi_overbought" name="rsi_overbought"
                  value="{{strategy_details.rsi_overbought}}" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="rsi_oversold" class="form-label">RSI Oversold Threshold:</label>
                <input type="number" step="0.01" class="form-control" id="rsi_oversold" name="rsi_oversold"
                  value="{{strategy_details.rsi_oversold}}" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="trade_percentage" class="form-label">Trade Percentage:</label>
                <input type="number" step="0.01" class="form-control" id="trade_percentage" name="trade_percentage"
                  value="{{strategy_details.trade_percentage}}" required min="0" max="1">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="trade_size" class="form-label">Trade Size (will override the percentage):</label>
                <input type="number" step="0.01" class="form-control" id="trade_size" name="trade_size"
                  value="{{strategy_details.trade_size}}">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <button type="submit" class="btn btn-primary m-2">
                {% if binance_manager_status == 'Running' %}
                Update
                {% else %}
                Start
                {% endif %}
              </button>
              <button type="submit" class="btn btn-danger m-2"
                formaction="{{ url_for('livetest.stop_binance_websocket') }}" {% if binance_manager_status=='Stopped'
                %}disabled{% endif %}>
                Stop
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo"
        aria-expanded="false" aria-controls="collapseTwo">
        Account Control
      </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
      data-bs-parent="#accordionExample">
      <div class="accordion-body">
        <form action="{{ url_for('livetest.set_crypto_balances') }}" method="post">
          <div class="mb-3">
            <label for="UsdtBalance" class="form-label">Usdt:</label>
            <input type="number" step="0.01" class="form-control" id="UsdtBalance" name="UsdtBalance"
              placeholder="Enter balance">
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col">
              <form action="{{ url_for('livetest.show_logs') }}" method="GET">
                <button type="submit" class="btn btn-primary">Show Logs</button>
              </form>
            </div>
            <div class="col">
              <p>Status: {{ binance_manager_status }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Price:</h5>
          <p class="card-text"><span id="last_close"></span></p>
          <h5 class="card-title">BBU:</h5>
          <p class="card-text"><span id="last_bbu"></span></p>
          <h5 class="card-title">BBL:</h5>
          <p class="card-text"><span id="last_bbl"></span></p>
          <h5 class="card-title">RSI:</h5>
          <p class="card-text"><span id="last_rsi"></span></p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Total Trades:</h5>
          <p class="card-text"><span id="total_trades"></span></p>
          <h5 class="card-title">Total Profit:</h5>
          <p class="card-text"><span id="total_profit"></span></p>
          <h5 class="card-title">Last action:</h5>
          <p class="card-text"><span id="last_action"></span></p>
          <h5 class="card-title">Last action price:</h5>
          <p class="card-text"><span id="last_price"></span></p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Initial base balance:</h5>
          <p class="card-text"><span id="initial_base_balance"></span></p>
          <h5 class="card-title">Final base balance:</h5>
          <p class="card-text"><span id="final_base_balance"></span></p>
          <h5 class="card-title">Initial quote balance:</h5>
          <p class="card-text"><span id="initial_quote_balance"></span></p>
          <h5 class="card-title">Final quote balance:</h5>
          <p class="card-text"><span id="final_quote_balance"></span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="live-plot"></div>
<div id="rsi-plot"></div>

<script>
  var socket = io.connect("{{socket_url}}");
  var rsiOversold = '{{ strategy_details.rsi_oversold }}';
  var rsiOverbought = '{{ strategy_details.rsi_overbought }}';


  socket.on("connect", function (data) {
    console.log("connected");
  });

  socket.on("update_data", function (data) {

    var last_signal = JSON.parse(data.last_signal);
    document.getElementById("last_bbu").innerHTML = Math.round(last_signal.BBU * 100) / 100;
    document.getElementById("last_close").innerHTML = Math.round(last_signal.close * 100) / 100;
    document.getElementById("last_bbl").innerHTML = Math.round(last_signal.BBL * 100) / 100;
    document.getElementById("last_rsi").innerHTML = Math.round(last_signal.RSI * 100) / 100;

    document.getElementById("last_action").innerHTML = data.last_action;
    document.getElementById("last_price").innerHTML = data.last_price;

    document.getElementById("total_trades").innerHTML = data.total_trades_count;
    document.getElementById("total_profit").innerHTML = data.total_profit;

    document.getElementById("initial_base_balance").innerHTML = data.initial_base_balance;
    document.getElementById("initial_quote_balance").innerHTML = data.initial_quote_balance;
    document.getElementById("final_base_balance").innerHTML = data.final_base_balance;
    document.getElementById("final_quote_balance").innerHTML = data.final_quote_balance;

    var close_trace = {
      x: data.price_x_data,
      y: data.price_y_data,
      type: "scatter",
      name: "Price"
    };

    var bbu_trace = {
      x: data.bbl_bbu_x_data,
      y: data.bbu_y_data,
      type: "scatter",
      line: { dash: "dot", color: "LightCoral" },
      name: "BBU"
    };

    var bbl_trace = {
      x: data.bbl_bbu_x_data,
      y: data.bbl_y_data,
      type: "scatter",
      line: { dash: "dot", color: "DarkCyan" },
      name: "BBL"
    };


    var buy_signal_trace = {
      x: data.buy_signal_x_data,
      y: data.buy_signal_y_data,
      mode: 'markers',
      name: 'Buy',
      marker: {
        color: 'green',
        size: 12
      }
    };

    var sell_signal_trace = {
      x: data.sell_signal_x_data,
      y: data.sell_signal_y_data,
      mode: 'markers',
      name: 'SELL',
      marker: {
        color: 'red',
        size: 12
      }
    };


    var rsi_trace = {
      x: data.rsi_x_data,
      y: data.rsi_y_data,
      xaxis: 'x2',
      yaxis: 'y2',
      type: "scatter",
      line: { color: "DarkRed" },
      name: "RSI"
    };

    var layout = {
      height: 800,
      grid: {
        rows: 2,
        columns: 1,
        pattern: 'independent'
      },
      
      yaxis: { 
        domain: [0.3, 1] 
      },
      yaxis2: {
        domain: [0, 0.2],
        tickvals: [rsiOversold, rsiOverbought],
        gridcolor: 'rgba(100, 100, 100, 0.5)'
      },
      xaxis2:{
        matches:'x',
        showgrid: false
      }
    };

    Plotly.react("live-plot", [close_trace, bbu_trace, bbl_trace, buy_signal_trace, sell_signal_trace, rsi_trace], layout);

  });
</script>

{% endblock %}